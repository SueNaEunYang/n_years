<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Në…„ ë°ì´í„° ì´ë¦„ ì¶”ì¶œê¸° (ë³µêµ¬íŒ)</title>

<style>
  :root {
    --primary: #1976d2;
    --primary-dark: #0f5ca3;
    --border: #e2e8f0;
    --card-bg: #ffffff;
    --badge-bg: #e3f2fd;
    --text-muted: #6b7280;
    --radius: 8px;
    --shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  body {
    font-family: "Noto Sans KR", sans-serif;
    background: #f7f9fc;
    margin: 0;
    padding: 30px;
    display: flex;
    justify-content: center;
  }

  .container {
    width: 100%;
    max-width: 860px;
    background: white;
    padding: 36px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  h1 { margin-top: 0; font-size: 26px; color: #111; text-align: center; }

  textarea {
    width: 100%;
    height: 160px;
    margin: 12px 0;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-family: monospace;
    box-sizing: border-box;
    resize: vertical;
  }

  button, select {
    padding: 10px 18px;
    font-size: 15px;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
  }

  button.primary { background: var(--primary); color: white; font-weight: 500; }
  button.primary:hover { background: var(--primary-dark); }

  button.secondary { background: #e5e7eb; color: #111; }
  button.secondary:hover { background: #d1d5db; }

  .options { margin: 12px 0; display: flex; gap: 12px; align-items: center; }

  .result { margin-top: 30px; }

  .card {
    background: var(--card-bg);
    padding: 20px 24px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-top: 20px;
    position: relative;
  }

  .badge {
    background: var(--badge-bg);
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 14px;
    margin-left: 8px;
    color: var(--primary-dark);
  }

  .copy-btn {
    position: absolute;
    right: 16px;
    top: 16px;
    background: var(--primary);
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 13px;
  }
  .copy-btn:hover { background: var(--primary-dark); }

  .note { color: var(--text-muted); font-size: 14px; margin-top: 6px; }

  /* Toast */
  .toast {
    visibility: hidden;
    min-width: 200px;
    background-color: #111;
    color: #fff;
    text-align: center;
    border-radius: var(--radius);
    padding: 10px;
    position: fixed;
    z-index: 10;
    right: 20px;
    bottom: 20px;
    opacity: 0;
    transition: opacity .25s;
  }
  .toast.show {
    visibility: visible;
    opacity: 1;
  }
</style>
</head>
<body>
<div class="container">

  <h1>Në…„ ë°ì´í„° ì´ë¦„ ì¶”ì¶œê¸°</h1>
  <p class="note">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ í‘œ ì „ì²´(ì œëª©í–‰ í¬í•¨)ë¥¼ ë³µì‚¬í•˜ì—¬ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (íƒ­, ì‰¼í‘œ, ê³µë°± êµ¬ë¶„ì„ ì§€ì›í•©ë‹ˆë‹¤. ë™ëª…ì´ì¸ ë“± ë””í…Œì¼ ì²˜ë¦¬ê°€ ë¯¸í¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)</p>

  <button class="secondary" onclick="loadSample()">ìƒ˜í”Œ ë°ì´í„° ìë™ ì…ë ¥</button>
  <textarea id="input" placeholder="ì˜ˆ:
2023	2024	2025
ê¹€ë‚˜ì€	ê¹€ì•„ì˜	ê¹€ë‚˜ì€
ê¹€ì•„ì˜	ì´ë‚˜ì€	ìµœë‚˜ì€"></textarea>

  <div class="options">
    <label>ìµœê·¼ ë¹„êµ:
      <select id="yearRange">
        <option value="2">ìµœê·¼ 2ë…„</option>
        <option value="3" selected>ìµœê·¼ 3ë…„</option>
        <option value="4">ìµœê·¼ 4ë…„</option>
      </select>
    </label>

    <button class="primary" onclick="processData()">ì¶”ì¶œí•˜ê¸° â–¶</button>
    <button class="secondary" onclick="analyzeAllRanges()">ëª¨ë“  êµ¬ê°„ ìë™ ë¹„êµ</button>
  </div>

  <div id="yearSelection"></div>
  <div class="result" id="output"></div>

</div>

<div id="toast" class="toast">ë©”ì‹œì§€</div>

<script>
/* ---------- ì „ì—­ ë°ì´í„° ---------- */
let headers = [];       // ['2023','2024',...]
let yearSets = [];      // [ Set(names for col0), Set(col1), ... ]

/* ---------- ìœ í‹¸: ì•ˆì „í•œ í–‰ ë¶„í•´ (ìš°ì„  íƒ­) ---------- */
function splitColumns(line) {
  if (typeof line !== 'string') return [];
  // ìš°ì„  íƒ­ìœ¼ë¡œ ë¶„ë¦¬
  const byTab = line.split('\t').map(s => s.trim()).filter(Boolean);
  if (byTab.length > 1) return byTab;
  // íƒ­ì´ ì—†ìœ¼ë©´ ì‰¼í‘œë¡œ ì‹œë„
  const byComma = line.split(',').map(s => s.trim()).filter(Boolean);
  if (byComma.length > 1) return byComma;
  // ë§ˆì§€ë§‰ìœ¼ë¡œ ì—¬ëŸ¬ ê³µë°±(2ê°œ ì´ìƒ) ë˜ëŠ” ë‹¨ì¼ ê³µë°±ìœ¼ë¡œ ë¶„ë¦¬
  return line.split(/\s+/).map(s => s.trim()).filter(Boolean);
}

/* ---------- ìƒ˜í”Œ ë¡œë“œ ---------- */
function loadSample() {
  document.getElementById("input").value =
`2023	2024	2025
ê¹€ë‚˜ì€	ê¹€ì•„ì˜	ê¹€ë‚˜ì€
ê¹€ì•„ì˜	ì´ë‚˜ì€	ìµœë‚˜ì€`;
  toast("ìƒ˜í”Œ ë°ì´í„° ì…ë ¥ë¨");
}

/* ---------- ë©”ì¸: ë°ì´í„° íŒŒì‹± ë° ì¤€ë¹„ ---------- */
function processData() {
  const raw = (document.getElementById("input").value || "").trim();
  if (!raw) {
    toast("ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
    return;
  }

  const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  if (lines.length < 2) {
    toast("ìµœì†Œ ì œëª©í–‰(ì—°ë„)ê³¼ ë°ì´í„°í–‰ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    return;
  }

  // í—¤ë”(ì œëª©í–‰) íŒŒì‹±
  headers = splitColumns(lines[0]);
  if (headers.length < 1) {
    toast("í—¤ë”(ì—°ë„)ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  const yearCount = headers.length;
  yearSets = Array.from({length: yearCount}, () => new Set());

  // ë°ì´í„°í–‰ íŒŒì‹±
  for (let i = 1; i < lines.length; i++) {
    const cols = splitColumns(lines[i]);
    for (let j = 0; j < Math.min(cols.length, yearCount); j++) {
      const name = cols[j].trim();
      if (name !== "") yearSets[j].add(name);
    }
  }

  // ìµœì†Œ í•œ ê°œì˜ ë°ì´í„°ê°€ ë“¤ì–´ìˆëŠ”ì§€ í™•ì¸
  const anyData = yearSets.some(s => s.size > 0);
  if (!anyData) {
    toast("ë°ì´í„° í–‰ì—ì„œ ì´ë¦„ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    return;
  }

  renderYearOptions();
  toast("ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ íŒŒì‹±ë˜ì—ˆìŠµë‹ˆë‹¤.");
  console.log("headers:", headers);
  console.log("yearSets sizes:", yearSets.map(s => s.size));
}

/* ---------- ì—°ë„ ì„ íƒ UI ë Œë” ---------- */
function renderYearOptions() {
  if (!headers || headers.length === 0) return;
  const n = parseInt(document.getElementById("yearRange").value, 10);
  const container = document.getElementById("yearSelection");
  container.innerHTML = `<p><b>ë¹„êµí•  ì—°ë„ êµ¬ê°„ ì„ íƒ:</b></p>`;

  const options = [];
  for (let i = 0; i <= headers.length - n; i++) {
    options.push({ start: i, label: `${headers[i]} ~ ${headers[i+n-1]}` });
  }

  if (options.length === 0) {
    container.innerHTML += `<p class="note">ì„ íƒí•œ Nê°œë…„(${n}) ìœ¼ë¡œ ìƒì„± ê°€ëŠ¥í•œ êµ¬ê°„ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
    return;
  }

  options.forEach((opt, idx) => {
    const id = `range_${idx}`;
    container.innerHTML += `
      <label style="margin-right:8px">
        <input type="radio" name="yearRangeRadio" id="${id}" value="${opt.start}" ${idx===options.length-1 ? 'checked' : ''}>
        ${opt.label}
      </label>
    `;
  });

  container.innerHTML += `<div style="margin-top:12px;">
    <button class="primary" onclick="analyzeSelectedRange()">ì„ íƒ êµ¬ê°„ë§Œ ë¶„ì„</button>
    <button class="secondary" style="margin-left:8px" onclick="analyzeAllRanges()">ëª¨ë“  êµ¬ê°„ ìë™ ë¹„êµ</button>
  </div>`;
}

/* ---------- í•µì‹¬: êµ¬ê°„ ë¶„ì„ í•¨ìˆ˜ (ì•ˆì „í•˜ê²Œ êµì§‘í•© ê³„ì‚°) ---------- */
function intersectionOfSets(setsArray) {
  if (!setsArray || setsArray.length === 0) return [];
  // ì‹œì‘ ê¸°ì¤€: ì²« ì„¸íŠ¸(ì„±ëŠ¥ìƒì˜ ì´ìœ )
  let inter = new Set(setsArray[0]);
  for (let i = 1; i < setsArray.length; i++) {
    const next = setsArray[i];
    inter = new Set([...inter].filter(x => next.has(x)));
    if (inter.size === 0) break;
  }
  return [...inter].sort((a,b) => a.localeCompare(b, 'ko'));
}

function analyzeRange(startIndex, n) {
  // recent sets for the selected window
  const recentSets = yearSets.slice(startIndex, startIndex + n);
  // years labels
  const rangeYears = headers.slice(startIndex, startIndex + n);

  // allNames = union of all yearSets
  const allNamesUnion = new Set();
  yearSets.forEach(s => s.forEach(name => allNamesUnion.add(name)));

  // ì „ì²´(ëª¨ë“  ì—°ë„) ë“±ì¥ì: intersection across ALL yearSets
  const overallIntersection = intersectionOfSets(yearSets);

  // ì„ íƒ êµ¬ê°„ Nê°œë…„ ì—°ì† ë“±ì¥ì
  const selectedIntersection = intersectionOfSets(recentSets);

  return {
    label: `${rangeYears[0]} ~ ${rangeYears[rangeYears.length - 1]}`,
    years: rangeYears,
    names: selectedIntersection,
    allNames: overallIntersection,
    unionNames: [...allNamesUnion].sort((a,b)=>a.localeCompare(b,'ko'))
  };
}

/* ---------- ë™ì‘: ì„ íƒ êµ¬ê°„ë§Œ ë¶„ì„ ---------- */
function analyzeSelectedRange() {
  if (!headers || headers.length === 0) { toast("ë¨¼ì € ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ê³  ì¶”ì¶œí•˜ì„¸ìš”."); return; }
  const n = parseInt(document.getElementById("yearRange").value, 10);
  const radios = document.getElementsByName("yearRangeRadio");
  if (!radios || radios.length === 0) {
    toast("ë¹„êµí•  êµ¬ê°„ì„ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”.");
    return;
  }
  let startIndex = 0;
  for (const r of radios) if (r.checked) startIndex = parseInt(r.value, 10);

  const res = analyzeRange(startIndex, n);
  renderOutput([res]);
}

/* ---------- ëª¨ë“  êµ¬ê°„ ìë™ ë¶„ì„ (ì—¬ëŸ¬ ê²°ê³¼) ---------- */
function analyzeAllRanges() {
  if (!headers || headers.length === 0) { toast("ë¨¼ì € ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ê³  ì¶”ì¶œí•˜ì„¸ìš”."); return; }
  const n = parseInt(document.getElementById("yearRange").value, 10);
  const results = [];
  for (let i = 0; i <= headers.length - n; i++) {
    results.push(analyzeRange(i, n));
  }
  renderOutput(results);
}

/* ---------- ì¶œë ¥ ë Œë”(ì¹´ë“œ) + TSV ë³µì‚¬ í…ìŠ¤íŠ¸ êµ¬ì„± ---------- */
function renderOutput(results) {
  const output = document.getElementById("output");
  output.innerHTML = "";

  if (!results || results.length === 0) {
    output.innerHTML = `<p class="note">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
    return;
  }

  // ì „ì²´(ëª¨ë“  ì—°ë„) í‘œì‹œëŠ” ì²« ê²°ê³¼ì˜ allNames ì‚¬ìš© (ë™ì¼í•˜ë¯€ë¡œ)
  const fullLabel = `${headers[0]} ~ ${headers[headers.length - 1]}`;
  const overall = results[0].allNames || [];
  // ì „ì²´ ì¹´ë“œ
  addCard("ì „ì²´(ëª¨ë“  ì—°ë„ì— ë“±ì¥)", fullLabel, overall, makeTSVRow("ì „ì²´", fullLabel, overall));

  // ê° êµ¬ê°„ ì¹´ë“œ
  results.forEach(res => {
    addCard(`${res.years.length}ê°œë…„ ê³µí†µ ë“±ì¥`, res.label, res.names, makeTSVRow("ì„ íƒêµ¬ê°„", res.label, res.names));
  });

  // ì•„ë˜ì— ì „ì²´ TSV ë³µì‚¬ ë²„íŠ¼
  const tsvAll = makeTSVForResults(results);
  output.innerHTML += `<div style="margin-top:12px"><button class="primary" onclick='copyToClipboard(${JSON.stringify(tsvAll)})'>ğŸ“‹ ëª¨ë“  ê²°ê³¼ TSV ë³µì‚¬ (ìŠ¤í”„ë ˆë“œì‹œíŠ¸ìš©)</button></div>`;
}

/* ì¹´ë“œ ì¶”ê°€ */
function addCard(title, label, list, tsvTextForThisCard) {
  const output = document.getElementById("output");
  const namesStr = (Array.isArray(list) ? list.join(", ") : (list || "ì—†ìŒ"));
  const count = (Array.isArray(list) ? list.length : 0);

  // escape for injection safety in attributes - but we're not injecting arbitrary HTML, so minimal
  const safeNames = namesStr.replace(/</g, "&lt;").replace(/>/g, "&gt;");

  output.innerHTML += `
    <div class="card">
      <button class="copy-btn" onclick='copyToClipboard(${JSON.stringify(tsvTextForThisCard)})'>ë³µì‚¬</button>
      <div style="font-weight:600">${title} <span style="color:#555">Â· ${label}</span>
        <span class="badge">${count}ëª…</span>
      </div>
      <p style="margin-top:12px">${safeNames}</p>
    </div>
  `;
}

/* TSV helper: single row (êµ¬ë¶„, ì—°ë„ë²”ìœ„, ì´ë¦„1,ì´ë¦„2,...) */
function makeTSVRow(kind, label, namesArray) {
  const names = (Array.isArray(namesArray) ? namesArray : []);
  // ê²°ê³¼ëŠ” íƒ­ìœ¼ë¡œ êµ¬ë¶„: êµ¬ë¶„ \t ì—°ë„ë²”ìœ„ \t ì´ë¦„1,ì´ë¦„2,...
  return `${kind}\t${label}\t${names.join(", ")}`;
}

/* ëª¨ë“  ê²°ê³¼ì— ëŒ€í•œ TSV (ì—¬ëŸ¬ í–‰) */
function makeTSVForResults(results) {
  const rows = [["êµ¬ë¶„", "ì—°ë„ë²”ìœ„", "ì´ë¦„(ì‰¼í‘œêµ¬ë¶„)"]];
  // ì „ì²´
  const overall = results[0]?.allNames || [];
  rows.push(["ì „ì²´(ëª¨ë“ ì—°ë„)", `${headers[0]} ~ ${headers[headers.length-1]}`, overall.join(", ")]);
  // ê° êµ¬ê°„
  results.forEach(res => {
    rows.push([`${res.years.length}ê°œë…„`, res.label, (res.names || []).join(", ")]);
  });
  return rows.map(r => r.join("\t")).join("\n");
}

/* ---------- ë³µì‚¬ & í† ìŠ¤íŠ¸ ---------- */
function copyToClipboard(text) {
  if (!text) { toast("ë³µì‚¬í•  í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
  navigator.clipboard.writeText(text)
    .then(() => {
      toast("ê²°ê³¼ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.");
    })
    .catch(err => {
      console.error("clipboard error:", err);
      toast("ë³µì‚¬ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
    });
}

function toast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 1500);
}
</script>
</body>
</html>
